<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Görev & Mesaj Sistemi</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,sans-serif;background:#eceff1;margin:0;padding:0}
header{background:#263238;color:#fff;padding:15px;text-align:center;font-size:20px}
.card{background:#fff;margin:15px;padding:15px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.2)}
input,button{width:100%;padding:8px;margin:6px 0;font-size:14px;border-radius:6px;border:1px solid #ccc}
button{background:#2196F3;color:#fff;border:none;cursor:pointer}
button:hover{opacity:0.85}
.task{border:1px solid #aaa;border-radius:6px;padding:8px;margin:5px 0}
.msg{background:#f5f5f5;padding:6px;border-radius:5px;margin:4px 0}
</style>
</head>
<body>

<header>Görev & Mesaj Sistemi</header>

<!-- LOGIN -->
<div class="card" id="login">
<h3>Giriş</h3>
<input id="gmail" placeholder="Gmail">
<input id="rumuz" placeholder="Rumuz">
<input id="sifre" type="password" placeholder="Şifre">
<button onclick="login()">Giriş Yap</button>
</div>

<!-- APP -->
<div class="card" id="app" style="display:none">
<h3>Yeni Görev</h3>
<input type="text" id="baslik" placeholder="Başlık">
<input type="text" id="aciklama" placeholder="Açıklama">
<button onclick="gorevEkle()">Görev Kaydet</button>

<hr>
<h3>Mesaj</h3>
<input id="mesajInput" placeholder="Mesaj yaz">
<button onclick="mesajGonder()">Mesaj Gönder</button>

<hr>
<h3>Görevler</h3>
<div id="gorevListe">Henüz görev yok</div>

<hr>
<h3>Mesajlar</h3>
<div id="mesajListe">Henüz mesaj yok</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzk54RQgoTibLfA5Yn6Jvz9PGgdpWtu6S4Vh9lf4hILXGyFwOX1seMajPtFlgvhWEY3/exec";

// SHA256 Fonksiyonu
async function sha256(str){
  const buffer = new TextEncoder("utf-8").encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

// LOGIN
async function login(){
  if(!gmail.value || !rumuz.value || !sifre.value){ alert("Boş alan bırakma"); return; }
  const hash = await sha256(sifre.value.trim());

  fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({tip:"login", gmail:gmail.value.trim(), rumuz:rumuz.value.trim(), hash:hash})
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.status=="ok"){
      login.style.display="none";
      app.style.display="block";
      veriGetir();
      setInterval(veriGetir,5000);
    } else alert(d.message);
  })
  .catch(e=>alert("Bağlantı hatası: "+e));
}

// GÖREV EKLE
function gorevEkle(){
  const bas = baslik.value.trim();
  const acik = aciklama.value.trim();
  if(!bas){ alert("Başlık boş olamaz"); return; }
  const tarihSaat = new Date().toLocaleDateString();
  const saat = new Date().toLocaleTimeString();

  fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({tip:"not", tarihSaat:tarihSaat, saat:saat, baslik:bas, aciklama:acik, kullanici:rumuz.value.trim()})
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.status=="ok"){ baslik.value=""; aciklama.value=""; veriGetir(); }
    else alert(d.message);
  })
  .catch(e=>alert("Görev ekleme hatası: "+e));
}

// MESAJ GÖNDER
function mesajGonder(){
  const msg = mesajInput.value.trim();
  if(!msg){ alert("Mesaj boş olamaz"); return; }
  const tarih = new Date().toLocaleDateString();
  const saat = new Date().toLocaleTimeString();

  fetch(API,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({tip:"mesaj", mesaj:msg, tarih:tarih, saat:saat, kullanici:rumuz.value.trim()})
  })
  .then(r=>r.json())
  .then(d=>{ mesajInput.value=""; veriGetir(); })
  .catch(e=>alert("Mesaj gönderme hatası: "+e));
}

// VERİ ÇEK
function veriGetir(){
  fetch(API)
  .then(r=>r.json())
  .then(d=>{
    let gorevHtml="", mesajHtml="";
    d.veriler.forEach(r=>{
      if(r[0]=="not"){
        gorevHtml += `<div class="task"><b>${r[1]} ${r[2]}</b><br>${r[3]}<br>${r[4]}<br><small>${r[5]}</small></div>`;
      }
      if(r[0]=="mesaj"){
        mesajHtml += `<div class="msg"><b>${r[5]}</b>: ${r[4]}</div>`;
      }
    });
    gorevListe.innerHTML = gorevHtml || "Henüz görev yok";
    mesajListe.innerHTML = mesajHtml || "Henüz mesaj yok";
  })
  .catch(e=>console.error("Veri çekme hatası: ",e));
}
</script>

</body>
</html>
