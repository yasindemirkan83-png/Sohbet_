<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sohbet App</title>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
body,html{width:100%;height:100%;background:black;color:white;overflow:hidden;}
#splash,#login,#app,#settings{position:fixed;top:0;left:0;width:100%;height:100%;}
#splash video,#app video{width:100%;height:100%;object-fit:cover;}
#login{display:none;align-items:center;justify-content:center;flex-direction:column;background:black;z-index:10;}
#login img{width:120px;cursor:pointer;margin-top:20px;}
#app{display:none;z-index:5;display:flex;flex-direction:column;}
#header{height:50px;display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(0,0,0,0.6);}
#settingsBtn{font-size:24px;cursor:pointer;}
#mainPanels{flex:1;display:flex;flex-direction:column;}
#tasksCard{flex:3;overflow-y:auto;}
#chatCard{flex:1;overflow-y:auto;margin-top:5px;}
.card{background:rgba(0,0,0,0.7);border-radius:12px;margin:10px;padding:15px;display:flex;flex-direction:column;}
.task-inputs input{margin:2px 0;padding:6px;border-radius:6px;border:none;}
.icon-buttons{display:flex;gap:4px;margin-top:4px;}
.icon-buttons button{flex:1;padding:6px;border:none;border-radius:6px;background:#1abc9c;color:black;cursor:pointer;}
#tasks,#chatBox{flex:1;overflow-y:auto;padding:4px;}
.task-item.selected{background:rgba(56,189,248,0.4);border-radius:6px;margin:2px;padding:4px;}
.msg-item{margin:2px;padding:4px;border-radius:6px;display:flex;justify-content:space-between;}
.msg-meta{font-size:0.7rem;color:#ccc;}
#settings{display:none;background:black;z-index:15;padding:20px;overflow-y:auto;}
.user-item{margin:2px;padding:4px;background:#222;border-radius:6px;}
</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash">
  <video src="açılış.mp4" autoplay muted></video>
</div>

<!-- LOGIN -->
<div id="login">
<h2>Gmail ile giriş</h2>
<img src="google-symbol.png" id="googleLogin">
</div>

<!-- APP -->
<div id="app">
  <video autoplay muted loop src="açılış.mp4" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;"></video>
  <div id="header">
    <div id="userName">Hoşgeldin</div>
    <div id="settingsBtn">⚙️</div>
  </div>

  <div id="mainPanels">
    <!-- Görev Kartı -->
    <div class="card" id="tasksCard">
      <h3>Görevler</h3>
      <div class="task-inputs">
        <input type="text" id="taskInput" placeholder="Görev adı">
        <input type="datetime-local" id="taskStart">
        <input type="datetime-local" id="taskEnd">
      </div>
      <div class="icon-buttons">
        <button onclick="addTask()">Ekle</button>
        <button onclick="deleteTask()">Sil</button>
        <button onclick="completeTask()">Tamamlandı</button>
        <button onclick="setAlarm()">Alarm Kur</button>
      </div>
      <div id="tasks"></div>
    </div>

    <!-- Mesaj Kartı -->
    <div class="card" id="chatCard">
      <h3>Mesajlar</h3>
      <div id="chatBox"></div>
      <div class="task-inputs">
        <input type="text" id="msgInput" placeholder="Mesaj yaz">
      </div>
      <div class="icon-buttons">
        <button onclick="sendMsg()">Gönder</button>
        <button onclick="deleteMsg()">Sil</button>
      </div>
    </div>
  </div>
</div>

<!-- AYARLAR -->
<div id="settings">
  <h2>Ayarlar / Yönetici Paneli</h2>
  <button onclick="backHome()">⬅ Geri</button>
  
  <h3>Kullanıcılar</h3>
  <div id="usersList"></div>

  <h3>Görüş & Öneri</h3>
  <textarea id="feedbackText" placeholder="Mesajınızı yazın..."></textarea>
  <button onclick="sendFeedback()">Gönder</button>

  <button onclick="logout()">Çıkış</button>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyDE5-fq9ifhtBlXTVOR1PhzD3XuVOWSVeE",
authDomain: "studio-3972799448-609d1.firebaseapp.com",
databaseURL: "https://studio-3972799448-609d1-default-rtdb.firebaseio.com",
projectId: "studio-3972799448-609d1",
storageBucket: "studio-3972799448-609d1.firebasestorage.app",
messagingSenderId: "210449601127",
appId: "1:210449601127:web:b3339666a09822b40c7ac2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

/* SPLASH -> LOGIN */
setTimeout(()=>{
  document.getElementById("splash").style.display="none";
  document.getElementById("login").style.display="flex";
},5000);

/* LOGIN */
document.getElementById("googleLogin").onclick=()=>{
  signInWithPopup(auth,provider);
};

/* AUTH */
onAuthStateChanged(auth,(user)=>{
  if(user){
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="flex";
    document.getElementById("userName").innerText=user.displayName;
    loadTasks();
    loadMessages();
    loadUsers();
  }
});

/* LOGOUT */
window.logout=()=>{
  signOut(auth);
  document.getElementById("settings").style.display="none";
  document.getElementById("app").style.display="none";
  document.getElementById("login").style.display="flex";
}

/* AYARLAR */
document.getElementById("settingsBtn").onclick=()=>{
  document.getElementById("app").style.display="none";
  document.getElementById("settings").style.display="block";
}
function backHome(){
  document.getElementById("settings").style.display="none";
  document.getElementById("app").style.display="flex";
}

/* FEEDBACK */
function sendFeedback(){
  const msg=document.getElementById('feedbackText').value;
  window.location.href=`mailto:yasindemirkan83@gmail.com?subject=Görüş & Öneri&body=${encodeURIComponent(msg)}`;
}

/* GÖREVLER */
function addTask(){
  const taskInput = document.getElementById('taskInput');
  const taskStart = document.getElementById('taskStart');
  const taskEnd = document.getElementById('taskEnd');
  const user = auth.currentUser;
  if(!taskInput.value || !user) return;
  const taskRef = ref(db, 'tasks');
  const newTaskRef = push(taskRef);
  set(newTaskRef,{
    name: taskInput.value,
    start: taskStart.value,
    end: taskEnd.value,
    user: user.uid,
    completed: false
  });
  taskInput.value=''; taskStart.value=''; taskEnd.value='';
}

/* LOAD TASKS */
function loadTasks(){
  const tasksDiv = document.getElementById('tasks');
  const tasksRef = ref(db,'tasks');
  tasksDiv.innerHTML='';
  onValue(tasksRef,(snapshot)=>{
    tasksDiv.innerHTML='';
    snapshot.forEach(snap=>{
      const data = snap.val();
      const div = document.createElement('div');
      div.className='task-item';
      div.dataset.key=snap.key;
      div.innerText=`${data.name} [${data.start} → ${data.end}] ${data.completed?'✅':''}`;
      div.onclick=()=>{ div.classList.toggle('selected'); }
      tasksDiv.prepend(div);
    });
  });
}

function deleteTask(){
  const selected = document.querySelectorAll('.task-item.selected');
  selected.forEach(div=>{
    remove(ref(db,'tasks/'+div.dataset.key));
  });
}

function completeTask(){
  const selected = document.querySelectorAll('.task-item.selected');
  selected.forEach(div=>{
    update(ref(db,'tasks/'+div.dataset.key),{completed:true});
  });
}

/* MESAJLAR */
function sendMsg(){
  const input = document.getElementById('msgInput');
  const user = auth.currentUser;
  if(!input.value || !user) return;
  const chatRef = ref(db,'messages');
  const newRef = push(chatRef);
  set(newRef,{
    user:user.displayName,
    text: input.value,
    time: new Date().toISOString()
  });
  input.value='';
}

function loadMessages(){
  const chatBox = document.getElementById('chatBox');
  const chatRef = ref(db,'messages');
  chatBox.innerHTML='';
  onValue(chatRef,(snapshot)=>{
    chatBox.innerHTML='';
    const msgs = [];
    snapshot.forEach(snap=>{
      msgs.push({...snap.val(),key:snap.key});
    });
    msgs.sort((a,b)=> new Date(b.time) - new Date(a.time));
    msgs.forEach(msg=>{
      const div = document.createElement('div');
      div.className='msg-item';
      div.dataset.key=msg.key;
      div.innerHTML=`<span>${msg.user}: ${msg.text}</span> <span class="msg-meta">${new Date(msg.time).toLocaleString()}</span>`;
      div.onclick=()=>{ div.classList.toggle('selected'); }
      chatBox.appendChild(div);
    });
  });
}

function deleteMsg(){
  const selected = document.querySelectorAll('.msg-item.selected');
  selected.forEach(div=>{
    remove(ref(db,'messages/'+div.dataset.key));
  });
}

/* USERS */
function loadUsers(){
  const usersList = document.getElementById('usersList');
  usersList.innerHTML='';
  const usersRef = ref(db,'tasks'); // Basit olarak uid ve name listele
  onValue(usersRef,(snapshot)=>{
    usersList.innerHTML='';
    snapshot.forEach(snap=>{
      const data = snap.val();
      const div = document.createElement('div');
      div.className='user-item';
      div.innerText=`${data.user || 'Anonim'}`;
      usersList.appendChild(div);
    });
  });
}

/* ALARM */
function setAlarm(){
  const selected = document.querySelectorAll('.task-item.selected');
  selected.forEach(div=>{
    const key = div.dataset.key;
    const taskRef = ref(db,'tasks/'+key);
    onValue(taskRef,(snap)=>{
      const data = snap.val();
      if(data.start){
        const ms = new Date(data.start).getTime() - Date.now();
        if(ms>0){
          setTimeout(()=>alert(`Alarm: ${data.name}`),ms);
        }
      }
    },{onlyOnce:true});
  });
}
</script>

</body>
</html>
